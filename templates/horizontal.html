{% extends "base.html" %}

{% block content %}

<div class="container">
  {% with messages = get_flashed_messages() %}
  {% if messages %}
  {% for msg in messages %}
  <div class="alert alert-info alert-dismissible fade show" role="alert">
    <strong> {{ msg }} </strong>
    <button type="button" class="close" data-dismiss="alert" aria-label="Close">
      <span aria-hidden="true">&times;</span>
    </button>
  </div>
  {% endfor %}
  {% endif %}
  {% endwith %}

  <div class="row">
    <!-- cell (0, 0) ============================================ -->
    <div class="col">
      <legend>Definir condiciones de fragmentacion</legend>

      Relaciones:

      <div class="container-fluid">
        <div class="row flex-row flex-nowrap">
          <ul class="list-group list-group-horizontal">
            <!-- <li class="list-group-item">Cras justo odio</li> -->
            {% for r in relations %}
            <li class="list-group-item">{{ r.0 }}</option>
              {% endfor %}
          </ul>
        </div>
      </div>

      <br>

      Seleccione una relacion
      <!-- <label for="relation">Relacion </label> -->
      <select name="sel-relation" id="sel-relation" class="custom-select mr-sm-2">
        {% if selected_relation %}
        <option selected>{{ selected_relation }}</option>
        {% endif %}
        {% for r in relations %}
        <option value="{{ r.0 }}">{{ r.0 }}</option>
        {% endfor %}
      </select>

    </div>

    <!-- cell (0, 1) ========================================================== -->
    <div class="col">
      <legend>Definir predicados simples</legend>

      <div class="form-row">
        <!-- attributes ..................................................... -->

        <div class="col">
          Atributo:
          <select class="custom-select mr-sm-2" name="sel-attribute" id='sel-attributes'>
            {% for attr in relation_attr %}
            <option value="{{attr.0}}">{{attr.0}}</option>
            {% endfor %}
          </select>
        </div>

        <!-- Operators ...................................................... -->
        <div class="col">
          Operador:
          <select class="custom-select mr-sm-2" name="sel-operator" id='sel-operator'>
            <option value="=">=</option>
            <option value="<">
              <</option> <option value="<=">
                <=</option> <option value=">">>
            </option>
            <option value=">=">>=</option>
            <option value="<>">
              <>
            </option>
          </select>
        </div>

        <div class="col">
          <!-- more code if you perform label for...  -->
          <!-- <label for="input-value">Valor </label> -->
          Valor:
          <input type="text" class="form-control" id="input-value" placeholder="Ponga el valor" name="txt-value">
        </div>

        <button id="btn-add-predicate" class="btn btn-secondary btn-sm" name="id-add-predicate">Agregar </button>
      </div>
    </div>


  </div>

  <br>

  <div class="row">
    <!-- cell (1, 0) ============================================================= -->

    <div class="col">

      <legend>Colocar fragmentos miniterminos</legend>

      <table class="table table-striped" id="table-predicates">
        <thead>
          <tr>
            <th scope="col">#</th>
            <th scope="col">Predicado</th>
          </tr>
        </thead>
        <tbody>
          {% for p in predicates %}
          <tr>
            <!-- <th scope="row">{{ p.0 }}</th> -->
            <td>{{ p.0 }}</td>
            <td>{{ p.1 }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>

      <button class="btn btn-secondary btn-block" id="btn-build-minterms">
        Generar miniterminos
      </button>
    </div>

    <!-- cell (1, 1) ============================================================================ -->
    <div class="col">
      <legend>Generar fragmentos miniterminos</legend>
      <!-- <div class="form-group">
          <label for="exampleFormControlTextarea1">Large textarea</label>
          <textarea class="form-control rounded-0" id="exampleFormControlTextarea1" rows="3"></textarea>
        </div> -->
      <div class="form-group">
        <select id="select-minterm-fragment" class="custom-select mr-sm-2">
          {% for mp in minterm_predicates %}
          <option value="{{ mp }}">{{ mp }}</option>
          {% endfor %}
        </select>
      </div>

      <!-- <div class="form-group">
          <select name="sel-site" class="custom-select mr-sm-2">
            <option value="S1">S1</option>
            <option value="S2">S2</option>
            <option value="S3">S3</option>
          </select>
        </div> -->

      <div class="form-group">
        <button class="btn btn-secondary btn-block" id="id-send-site">
          Enviar
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  const btnSendSite = document.getElementById('id-send-site');
  const selectMintermFragment = document.getElementById("select-minterm-fragment");

  btnSendSite.onclick = e => {
    const requestObject = mintermPredicates[Number(selectMintermFragment.value)]
    const requestString = JSON.stringify(requestObject)
    fetch('/send_site/' + requestString)
      .then(res => res.json())
      .then(res => console.log(res))
      .catch(err => console.log(err) )
  }

  const btnBuildMinterms = document.getElementById('btn-build-minterms');
  let simplePredicates = new Set();
  let mintermPredicates = [];

  btnBuildMinterms.onclick = e => {
    if (document.getElementById('table-predicates').tBodies[0].rows.length > 0) {
      const json = {
        'relation': selectRelation.value,
        'predicates': [...simplePredicates] // convert set into list, we do this since we cannot stringify a set since data is not stored as values
      }
      const jsonStr = JSON.stringify(json)
      console.log(jsonStr)
      fetch('/build_minterms/' + jsonStr)
        .then(res => res.json())
        .then(mintermPredicatesResponse => { // [ [ ] ] list of list where each element contains tree minterms
          mintermPredicates = mintermPredicatesResponse
          for (let i = 0; i < mintermPredicatesResponse.length; ++i) {
            const option = document.createElement('option')
            option.value = i // query the index and obtain the minterms selected when sending minterm fragments
            option.innerHTML = mintermPredicatesResponse[i].join(' | ')
            selectMintermFragment.appendChild(option)
          }

        })
        .catch(err => console.log(err))
    }
  }

  const selectRelation = document.getElementById('sel-relation');
  const selectAttributes = document.getElementById('sel-attributes');

  String.prototype.replaceAll = function (search, replacement) {
    var target = this;
    return target.split(search).join(replacement);
  };

  selectRelation.onchange = () => {
    const name = selectRelation.value;
    fetch('/relation_attributes/' + name)
      .then(res => res.json())
      .then(data => {
        const holder = '<option value="S">S</option>';
        selectAttributes.innerHTML = data.reduce((accumulator, current) =>
          accumulator + holder.replaceAll('S', current[0]), '')

        // let html = ''; // alternative way 
        // data.forEach(attrInfo => html += holder.replaceAll('S', attrInfo[0]));
        // selectAttributes.innerHTML = html;
      })
  }

  const selectOperator = document.getElementById('sel-operator');
  const textValue = document.getElementById('input-value');
  const btnAddPredicate = document.getElementById('btn-add-predicate');

  function addPredicate() {
    const json = {
      relation: selectRelation.value,
      attribute: selectAttributes.value, operator: selectOperator.value, value: textValue.value
    }
    const jsonStr = JSON.stringify(json);
    console.log(jsonStr)
    fetch('/append_predicate/' + jsonStr)
      .then(res => res.json())
      .then(res => {
        if (res['ok']) {
          delete json.relation
          simplePredicates.add(json)

          const tbodyPredicates = document.getElementById('table-predicates').tBodies[0]
          const n = tbodyPredicates.rows.length
          const tr = document.createElement('tr')
          const td0 = document.createElement('td'), td1 = document.createElement('td')

          td0.appendChild(document.createTextNode(String(n)))
          td1.appendChild(document.createTextNode(
            `${json['attribute']} ${json['operator']} ${json['value']}`));
          [td0, td1].forEach(td => tr.appendChild(td))
          tbodyPredicates.appendChild(tr)
        }
      })
      .catch(err => console.log(err));
  }

  const tablePredicates = document.getElementById("table-predicates");

  btnAddPredicate.onclick = e => {
    console.dir(tablePredicates)
    if (textValue.value.length > 0) {
      addPredicate();
    }
  }

  textValue.onkeypress = e => {
    console.dir(tablePredicates)
    if (textValue.value.length > 0 && e.keyCode === 13) { // pressed enter
      addPredicate();
    }
  }



</script>
{% endblock %}